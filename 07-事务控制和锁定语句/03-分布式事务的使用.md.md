## 1、分布式事务

`MySQL` 从 `5.0.3` 版本起开始支持分布式事务，当前分布式事务只支持 `InnoDB` 存储引擎。

一个分布式事务会涉及多个行动，这些行动本身是事务性的。

所有行动都必须一起成功完成，或者一起回滚。

在 `MySQL` 中，使用分布式事务的应用程序涉及一个或多个资源管理器和一个事务管理器。

资源管理器（`RM`）用于提供通向事务资源的途径，数据库服务器是一种资源管理器。

该管理器必须可以提交或回滚由RM管理的事务。

事务管理器（`TM`）用于协调作为一个分布式事务一部分的事务。`TM` 与管理每个事务的 `RM` 进行通信。在一个分布式事务中，各个单个事务均是分布式事务的”分支事务“。分布式事务和各分支通过一种命名方法进行标识。

要执行一个分布式事务，必须知道这个分布式事务涉及哪些资源管理器，并且把每个资源管理器的事务执行到事务可以被提交或回滚时。

用于执行分布式事务的过程使用两阶段提交，发生时间在由分布式事务的各个分支需要进行的行动已经被执行之后。

在第一阶段中，所有的分支被预备好。即它们被TM告知要准备提交。通常，这意味着用于管理分支的每个RM会记录对于被稳定保存的分支的行动。分支指示是否它们可以这么做。这些结果被用于第二阶段。

在第二阶段中，`TM` 告知 `RM` 是否要提交或回滚。如果在预备分支时，所有的分支指示它们将能够提交，则所有的分支被告知要提交。如果在预备时，有任何分支指示它将不能提交，则所有分支被告知回滚。

在有些情况下，一个分布式事务可能会使用一阶段提交。



分布式事务（`XA` 事务）的 `SQL` 语法如下：

`XA {START | BEGIN} xid [JOIN|RESUME]`

`xid` 值包含 `1~3` 个部分：`xid: [ gtrid ] [ bqual ] [ formatID ]`

`gtrid`：是一个分布式事务标识符，相同的分布式事务应该使用相同的 `gtrid` ，这样可以明确知识 `XA` 事务属于哪个分布式事务。

`bqual`：是一个分支限定符，默认值是空串。对于一个分布式事务中的每个分支事务，`bqual` 值必须是唯一的。

`formatID`：是一个数字，用于标识由 `gtrid` 和 `bqual` 值使用的格式，默认值是 `1`。

分布式的关键在于如何确保分布式事务的完整性，以及在某个分支出现问题时的故障解决。

`MySQL` 的分布式事务还存在一些问题，在数据库或者应用异常的情况下，可能会导致分布式事务的完整性或者需要人工介入处理。如果需要使用分布式事务，建议尽量采用 `MySQL5.7` 或者更新的版本。